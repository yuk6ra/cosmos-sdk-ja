---
sidebar_position: 1
---

# Blockchain Architecture

## State machine

ブロックチェーンの本質的な部分は、[複製された決定性ステートマシン](https://en.wikipedia.org/wiki/State_machine_replication)です。

ステートマシンは、コンピュータサイエンスの概念であり、マシンは複数の状態を持つことができますが、任意の時点でただ1つの状態しか持ちません。システムの現在の状態を示す「状態」と、状態遷移をトリガーする「トランザクション」が存在します。

状態SとトランザクションTが与えられた場合、ステートマシンは新しい状態S'を返します。

```text
+--------+                 +--------+
|        |                 |        |
|   S    +---------------->+   S'   |
|        |    apply(T)     |        |
+--------+                 +--------+
```

実際には、トランザクションは効率的な処理を行うためにブロックにまとめられます。状態SとトランザクションのブロックBが与えられた場合、ステートマシンは新しい状態S'を返します。

```text
+--------+                              +--------+
|        |                              |        |
|   S    +----------------------------> |   S'   |
|        |   For each T in B: apply(T)  |        |
+--------+                              +--------+
```

ブロックチェーンの文脈では、状態マシンは決定論的です。つまり、特定の状態でノードを起動し、同じトランザクションのシーケンスを再生すると、常に同じ最終状態になります。

Cosmos SDKは、開発者にアプリケーションの状態、トランザクションのタイプ、および状態遷移関数を定義する最大限の柔軟性を提供します。Cosmos SDKを使用してステートマシンを構築するプロセスについては、以下のセクションで詳しく説明します。しかしまず、**CometBFT**を使用して状態マシンが複製される方法を見てみましょう。

## CometBFT

Cosmos SDKのおかげで、開発者は状態マシンを定義するだけで済み、[*CometBFT*](https://docs.cometbft.com/v0.37/introduction/what-is-cometbft)がネットワーク上での複製を自動的に処理します。

```text
                ^  +-------------------------------+  ^
                |  |                               |  |   Built with Cosmos SDK
                |  |  State-machine = Application  |  |
                |  |                               |  v
                |  +-------------------------------+
                |  |                               |  ^
Blockchain node |  |           Consensus           |  |
                |  |                               |  |
                |  +-------------------------------+  |   CometBFT
                |  |                               |  |
                |  |           Networking          |  |
                |  |                               |  |
                v  +-------------------------------+  v
```

[CometBFT](https://docs.cometbft.com/v0.37/introduction/what-is-cometbft)は、ブロックチェーンの*ネットワーキング*と*合意*の層を担当するアプリケーションに依存しないエンジンです。実際には、CometBFTはトランザクションのバイトを伝播および順序付ける責任を持ちます。CometBFTは、ビザンチン障害耐性（BFT）アルゴリズムを利用してトランザクションの順序に合意を形成します。

CometBFTの[合意アルゴリズム](https://docs.cometbft.com/v0.37/introduction/what-is-cometbft#consensus-overview)は、*バリデータ*と呼ばれる特別なノードのセットと連携します。バリデータは、トランザクションのブロックをブロックチェーンに追加する責任を持ちます。任意のブロックで、バリデータセットVがあります。V内のバリデータは、次のブロックの提案者としてアルゴリズムによって選択されます。このブロックは、Vの3分の2以上がそれに対して`prevote`と`precommit`を署名し、かつ含まれるすべてのトランザクションが有効である場合に有効とされます。バリデータセットは、状態マシンで書かれたルールによって変更されることがあります。

## ABCI

CometBFTは、トランザクションをアプリケーションに伝達するためのインターフェースである [ABCI](https://docs.cometbft.com/v0.37/spec/abci/) を介してトランザクションを渡します。このABCIは、アプリケーションが実装する必要があります。

```text
              +---------------------+
              |                     |
              |     Application     |
              |                     |
              +--------+---+--------+
                       ^   |
                       |   | ABCI
                       |   v
              +--------+---+--------+
              |                     |
              |                     |
              |       CometBFT      |
              |                     |
              |                     |
              +---------------------+
```

注意しておくべきは、**CometBFTはトランザクションバイトのみを処理します**。これらのバイトがどのような意味を持つかはCometBFTにはわかりません。CometBFTが行うことは、これらのトランザクションバイトを決定論的に順序付けることです。CometBFTはこれらのバイトをABCIを介してアプリケーションに渡し、トランザクションに含まれるメッセージが正常に処理されたかどうかを示す戻りコードを期待します。

以下は、ABCIの中で最も重要なメッセージです：

* `CheckTx`：トランザクションがCometBFTに受信されると、アプリケーションに渡され、基本的な要件が満たされているかどうかをチェックします。 `CheckTx` はフルノードのメンプールをスパムトランザクションから保護するために使用されます。[`AnteHandler`](../basics/04-gas-fees.md#antehandler) と呼ばれる特別なハンドラが使用されて、十分な手数料のチェックや署名の検証などの一連のバリデーションステップが実行されます。チェックが有効な場合、トランザクションは[mempool](https://docs.cometbft.com/v0.37/spec/p2p/messages/mempool) に追加され、ピアノードに中継されます。`CheckTx` ではトランザクションは処理されません（つまり、状態の変更は発生しません）が、まだブロックに含まれていないためです。
* `DeliverTx`：CometBFTが[有効なブロック](https://docs.cometbft.com/v0.37/spec/core/data_structures#block) を受信すると、ブロック内の各トランザクションは `DeliverTx` を介してアプリケーションに渡され、処理されるようになります。この段階で、状態遷移が発生します。`AnteHandler` が再度実行され、トランザクション内の各メッセージの実際の[`Msg` サービス](../building-modules/03-msg-services.md) RPC とともに実行されます。
* `BeginBlock`/`EndBlock`：これらのメッセージは、ブロックがトランザクションを含んでいるかどうかに関わらず、各ブロックの始めと終わりで実行されます。これにより、ロジックの自動実行がトリガーされます。ただし、計算負荷の高いループはブロックチェーンの動作を遅くしたり、ループが無限である場合にはブロックチェーンをフリーズさせる可能性があるため、注意が必要です。

ABCIメソッドの詳細な説明については、[CometBFTドキュメント](https://docs.cometbft.com/v0.37/spec/abci/) を参照してください。

CometBFT上で構築されたアプリケーションは、ABCIインターフェースを実装して、基盤となるローカルCometBFTエンジンとの通信を行う必要があります。幸いなことに、ABCIインターフェースの実装は必要ありません。Cosmos SDKは、[baseapp](./03-sdk-design.md#baseapp) の形でそのボイラープレート実装を提供します。

